version: 0.2

phases:
  build:
    commands:
      - echo "Downloading latest Terraform"
      - curl -o terraform.zip https://releases.hashicorp.com/terraform/1.12.1/terraform_1.12.1_linux_amd64.zip
      - unzip terraform.zip
      - mv terraform /usr/local/bin/
      - terraform -version
      - cd S3

      # Initializing Terraform
      - echo "Initializing Terraform"
      - terraform init

      - echo "Validating Terraform configuration"
      - terraform validate

      # Checking if the S3 bucket name already exists
      - echo "Checking if S3 bucket name already exists..."
      - |
        if aws s3api head-bucket --bucket "$(grep bucket_name terraform.tfvars | cut -d'=' -f2 | tr -d ' \"')" 2>/dev/null; then
          echo "Bucket already exists. Please choose a different bucket name."
          exit 1
          
          else
              echo "Bucket does not exist. Proceeding with creation."
        fi

      # Planning the infrastructure
      - echo "Planning infrastructure"
      - terraform plan -out=tfplan -var-file="terraform.tfvars"

      # Applying the changes 
      - echo "Applying infrastructure"
      - terraform apply -auto-approve tfplan

      # # wait for 2 minutes for detsroying
      # - echo "Sleeping for 60 seconds before destroying..."
      # - sleep 120

      # # destroy the infrastructure     
      # - echo "Destroying infrastructure"
      # - terraform destroy -auto-approve -var-file="terraform.tfvars"




